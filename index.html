<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Generic Chat App</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"/>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<style type="text/css">
		body{
			margin-top: 30px;
			height: 100%;
		}	
		.my-message{
			margin-left: 80px;
		}
		.not-my-message{
			margin-right: 80px; 
		}
		#messageArea{
			display: none;
		}
		/*
		.barra-superior{
			padding: 0 20px 10px 20px;
		}
		.lista-superior{
			list-style-type: none;
			margin: 0;
		}
		.titulo{
			float: left;
			margin-top: 0;
		}
		.item-lista{
			margin-top: 10px;
			float:right;
		}
		.botao-emergencia{
			padding-left: 80px;
			padding-right: 80px;
			margin-top: 5px;
		}
		*/
		.caixa-texto{
			overflow-y: scroll;
			margin-top: 5px;
		}
		.mensagem-erro{
			color: red;
			margin-top: 5px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div id="userFormArea" class="row">
			<div class="col-md-12 col-sm-3">
				<form id="userForm">
					<div class="form-group">
						<label>Enter Username</label>
						<input class="form-control" id="username"/>
						<p id="errorMessage" class="mensagem-erro"></p>
						<br>
						<input type="submit" class="btn btn-primary" value="Login">
				</form>
			</div>			
		</div>
	</div>
	<div class="container">
		<div id="messageArea" class="row navbar navbar-fixed-top">
			<div id="onlineUsers" class="col-md-12">
				<div class="well">
					<h3>Online Users</h3>
						<!--
						<li class="item-lista"><button class="btn btn-danger botao-emergencia">EMERGÃŠNCIA</button></li> -->
					<ul class="list-group" id="users"></ul>
				</div>
			</div>
			<div class="col-md-12">
				<div class="chat caixa-texto" id="chat"></div>
			</div>
			<div id="typeArea" class="col-md-12 navbar navbar-fixed-bottom">
				<form id="messageForm">
					<div class="form-group">
						<label>Enter Message</label>
						<textarea class="form-control" id="message"></textarea>
						<br>
						
						<input type="submit" class="btn btn-primary" value="Send Message">
						
				</form>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		$(function(){
			var socket 		  = io.connect();
			var $messageForm  = $('#messageForm');
			var $message      = $('#message');
			var $chat 		  = $('#chat');
			var $userForm 	  = $('#userForm');
			var $userFormArea = $('#userFormArea');
			var $messageArea  = $('#messageArea');
			var $users 		  = $('#users');
			var $username 	  = $('#username');
			var $errorMessage = $('#errorMessage');
			var $onlineUsers  = $('#onlineUsers');
			var $typeArea 	  = $('#typeArea');
			var addHeight 	  = 0;

			$(window).resize(function(event) {
				setChatHeight();
				scrollBottomMessage();
			});

			$username.focus(); // Set focus to login input on load

			$message.keypress(function (e) {
    			if(e.which == 13 && !e.shiftKey) {        
		        	$messageForm.submit();
		        	e.preventDefault();
		        	return false;
		    	}
			});

			$messageForm.submit(function(e){
				setChatHeight();
				e.preventDefault();
				socket.emit('send message', $message.val());
				$message.val('');
			});
			
			socket.on('new message', function(data){
				if (data.user === $username.val()){
					$chat.append('<div class="well my-message"><strong>'+data.user+'</strong>: '+data.msg+'</div>')
				}else{
					$chat.append('<div class="well not-my-message"><strong>'+data.user+'</strong>: '+data.msg+'</div>')
				}
				addHeight += $chat.children().last().outerHeight(true);
				scrollBottomMessage();
			});

			$userForm.submit(function(e){
				e.preventDefault();
				if($username.val().length > 0){
					socket.emit('new user', $username.val(), function(data){
							if(data){
								$messageArea.show();
								$userFormArea.hide();
							}
					});
				}
				else{
					$errorMessage.html('Favor inserir um nome de usuario!');						
				}
			});

			socket.on('get users', function(data){
				var html = '';
				for(i = 0; i < data.length; i++){
					html += '<li class="list-group-item">'+data[i]+'</li>';
				}
				$users.html(html);
			});

			function scrollBottomMessage(){
				$chat.scrollTop(addHeight);
			}

			function setChatHeight(){
				var availableHeight = $(document).height() - ($onlineUsers.outerHeight(true) + $typeArea.outerHeight(true));
				if(availableHeight < 0)
					$onlineUsers.fadeOut(500);
				else
					$onlineUsers.fadeIn(500);
					availableHeight = $(document).height() - $typeArea.outerHeight(true);
				$chat.height(availableHeight);
			}
		});
	</script>

</body>
</html>